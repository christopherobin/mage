<!DOCTYPE html>
<html manifest="mui://manifest">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="format-detection" content="telephone=no"/>
	<style type="text/css">
		* { -webkit-touch-callout: none; -webkit-tap-highlight-color: rgba(0,0,0,0); -webkit-text-size-adjust: none; -webkit-user-select: none; -webkit-user-drag: none; }
		input, textarea { -webkit-user-select: text; }
		q:before, q:after { content: ''; }
		body { background: #000; }
	</style>
</head>
<body>

<script type="text/javascript">

window.mui = new function()
{
	var imageMap = mui.imageMapProvider;
	var partSplit = '---package-part---';
	var htmlClassName = 'mithrilui-package';
	var loadedCbs = {};
	var displayCbs = {};
	var error = function(msg) { alert(msg); };
	var displayedPackage = null;
	var that = this;

	var baseUrl = window.location.origin + window.location.pathname;
	if (baseUrl[baseUrl.length-1] === '/')
	{
		baseUrl = baseUrl.substring(0, baseUrl.length-1);
	}

	// package list

	var m = /packages=(.+?)(&|$)/.exec(window.location.hash);
	if (!m || !m[1])
	{
		return error('No package specified.');
	}

	this.packageQueue = decodeURIComponent(m[1]).split(',');


	// session ID

	var m = /session=(.+?)(&|$)/.exec(window.location.hash);
	if (!m || !m[1])
	{
		return error('No session specified.');
	}

	this.session = decodeURIComponent(m[1]);


	// page name

	var m = /^\/page\/(.+)(\/|$)/.exec(window.location.pathname);
	if (!m || !m[1])
	{
		return error('No page specified.');
	}

	this.pageName = decodeURIComponent(m[1]);


	// api

	this.loadPackage = function(name)
	{
		var xhr = new XMLHttpRequest();

		xhr.onreadystatechange = function() {
			if (xhr.readyState != 4) return;

			if (xhr.status == 0)
			{
				return error('No connection, please reload.');
			}

			var parts = xhr.responseText;
			if (!parts)
			{
				return error('Download failed, please reload.');
			}

			parts = parts.split(partSplit);
			var len = parts.length;

			for (var i=0; i < len; i++)
			{
				var part = parts[i];

				var eol = part.indexOf('\n');
				var mimetype = part.substring(0, eol);
				var content  = part.substring(eol + 1);

				switch (mimetype)
				{
					case 'text/html':
						var cnt = document.createElement('div');
						cnt.className = htmlClassName;
						cnt.setAttribute('data-package', name);
						cnt.innerHTML = content;
						cnt.style.display = 'none';
						document.body.appendChild(cnt);
						break;

					case 'text/javascript':
						var cnt = document.createElement('script');
						cnt.setAttribute('type', mimetype);
						cnt.setAttribute('data-package', name);
						cnt.innerHTML = content;
						document.head.appendChild(cnt);
						break;

					case 'text/css':
						var cnt = document.createElement('style');
						cnt.setAttribute('type', mimetype);
						cnt.setAttribute('data-package', name);
						cnt.innerHTML = content;
						document.head.appendChild(cnt);
						break;
				}
			}

			var cbs = loadedCbs[name];
			if (cbs)
			{
				var len = cbs.length;
				for (var i=0; i < len; i++)
				{
					cbs[i](name);
				}
			}

			if (!displayedPackage)
			{
				that.displayPackage(name);
			}

			that.loadNextPackage();
		};

		xhr.open('GET', baseUrl + '/' + name + '?partSplit=' + encodeURIComponent(partSplit), true);
		xhr.send(null);
	};


	this.onloaded = function(name, cb)
	{
		if (name in loadedCbs)
		{
			loadedCbs[name].push(cb);
		}
		else
			loadedCbs[name] = [cb];
	};


	this.ondisplay = function(name, cb)
	{
		if (name in displayCbs)
		{
			displayCbs[name].push(cb);
		}
		else
			displayCbs[name] = [cb];
	};


	this.loadNextPackage = function()
	{
		var next = this.packageQueue.shift();
		if (next)
		{
			this.loadPackage(next);
		}
	};


	this.displayPackage = function(name)
	{
		var packages = document.getElementsByClassName(htmlClassName);

		var found = false;
		var len = packages.length;
		for (var i=0; i < len; i++)
		{
			var elm = packages[i];

			if (elm.getAttribute('data-package') === name)
			{
				elm.style.display = '';
				displayedPackage = name;
				found = true;
			}
			else
			{
				elm.style.display = 'none';
			}
		}

		if (found)
		{
			var cbs = displayCbs[name];
			if (cbs)
			{
				var len = cbs.length;
				for (var i=0; i < len; i++)
				{
					cbs[i](name);
				}
			}
		}
	};


	this.img = function(descriptor)
	{
		if (!descriptor) return null;

		var img = imageMap.images[descriptor];
		if (!img) return null;

		var domain = img[0];
		var path = img[1];
		var version = img[2];
		var descParts;

		path = path.replace(/\$([0-9]+)/g, function(m) {
			if (m[1] == '0') return descriptor;

			if (!descParts) descParts = descriptor.split(imageMap.descriptorDelimiter);

			return descParts[m[1]-1];
		});

		return imageMap.domains[domain] + path + ((version && version != 1) ? ('?v' + version) : '');
	};


	this.loadNextPackage();
};

</script>

</body>
</html>
