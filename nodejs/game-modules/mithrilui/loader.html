<!DOCTYPE html>
<html manifest="mui://manifest">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="format-detection" content="telephone=no"/>
	<style type="text/css">
		* { -webkit-touch-callout: none; -webkit-tap-highlight-color: rgba(0,0,0,0); -webkit-text-size-adjust: none; -webkit-user-select: none; -webkit-user-drag: none; }
		input, textarea { -webkit-user-select: text; }
		q:before, q:after { content: ''; }
		body { background: #000; margin: 0; }
	</style>
</head>
<body>

<script type="text/javascript">

window.mui = new function()
{
	var imageMap;
	var partSplit = '---page-part---';
	var htmlClassName = 'mithrilui-page';
	var loadedCbs = {};
	var displayCbs = {};
	var error = function(msg) { alert(msg); };
	var displayedPage = null;
	var pageData = {};
	var that = this;

	var baseUrl = window.location.origin + window.location.pathname;
	if (baseUrl[baseUrl.length-1] === '/')
	{
		baseUrl = baseUrl.substring(0, baseUrl.length-1);
	}

	// page list

	var m = /pages=(.+?)(&|$)/.exec(window.location.hash);
	if (!m || !m[1])
	{
		return error('No page specified.');
	}

	this.pageQueue = decodeURIComponent(m[1]).split(',');


	// session ID

	var m = /session=(.+?)(&|$)/.exec(window.location.hash);
	if (!m || !m[1])
	{
		return error('No session specified.');
	}

	this.session = decodeURIComponent(m[1]);


	// language

	var m = /language=(.+?)(&|$)/.exec(window.location.search);
	if (!m || !m[1])
	{
		this.language = null;
	}
	else
		this.language = decodeURIComponent(m[1]);


	// api

	this.loadPage = function(name)
	{
		var xhr = new XMLHttpRequest();

		xhr.onreadystatechange = function() {
			if (xhr.readyState != 4) return;

			if (xhr.status == 0)
			{
				return; // error('No connection, please reload.');
			}

			var parts = xhr.responseText;
			if (!parts)
			{
				return error('Download failed, please reload.');
			}

			pageData[name] = {};

			parts = parts.split(partSplit);
			var len = parts.length;

			for (var i=0; i < len; i++)
			{
				var part = parts[i];

				var eol = part.indexOf('\n');
				var mimetype = part.substring(0, eol);
				var content  = part.substring(eol + 1);

				switch (mimetype)
				{
					case 'mui/imagemap':
						imageMap = JSON.parse(content);
						break;

					case 'text/html':
						var cnt = document.createElement('div');
						cnt.className = htmlClassName;
						cnt.setAttribute('data-page', name);
						cnt.innerHTML = content;
						cnt.style.display = 'none';
						document.body.appendChild(cnt);
						break;

					case 'text/javascript':
						var cnt = document.createElement('script');
						cnt.setAttribute('type', mimetype);
						cnt.setAttribute('data-page', name);
						cnt.innerHTML = content;
						document.head.appendChild(cnt);
						break;

					case 'text/css':
						pageData[name].css = content;
						break;
				}
			}

			var cbs = loadedCbs[name];
			if (cbs)
			{
				var len = cbs.length;
				for (var i=0; i < len; i++)
				{
					cbs[i](name);
				}
			}

			if (!displayedPage)
			{
				that.displayPage(name);
			}

			that.loadNextPage();
		};

		var url = baseUrl + '/' + name + '?partSplit=' + encodeURIComponent(partSplit);
		if (!imageMap)
		{
			url += '&imagemap=' + (that.language || '');
		}

		xhr.open('GET', url, true);
		xhr.send(null);
	};


	this.onloaded = function(name, cb)
	{
		if (name in loadedCbs)
		{
			loadedCbs[name].push(cb);
		}
		else
			loadedCbs[name] = [cb];
	};


	this.ondisplay = function(name, cb)
	{
		if (name in displayCbs)
		{
			displayCbs[name].push(cb);
		}
		else
			displayCbs[name] = [cb];
	};


	this.loadNextPage = function()
	{
		var next = this.pageQueue.shift();
		if (next)
		{
			this.loadPage(next);
		}
	};


	this.displayPage = function(name)
	{
		var pages = document.getElementsByClassName(htmlClassName);

		var found = false;
		for (var i=0, len = pages.length; i < len; i++)
		{
			var elm = pages[i];

			if (elm.getAttribute('data-page') === name)
			{
				found = elm;
			}

			elm.style.display = 'none';
		}

		if (!found) return;

		var cbs = displayCbs[name];
		if (cbs)
		{
			for (var i=0, len = cbs.length; i < len; i++)
			{
				cbs[i](name);
			}
		}

		if (displayedPage)
		{
			var displayedCss = document.querySelector('style[data-page="' + displayedPage + '"]');
			displayedCss.parentNode.removeChild(displayedCss);
		}

		if (pageData[name].css)
		{
			var cnt = document.createElement('style');
			cnt.setAttribute('type', 'text/css');
			cnt.setAttribute('data-page', name);
			cnt.innerHTML = pageData[name].css;
			document.head.appendChild(cnt);
		}

		found.style.display = '';

		displayedPage = name;
	};


	this.img = function(descriptor)
	{
		if (!descriptor) return null;

		var img = imageMap.images[descriptor];
		if (!img) return null;

		var domain = img[0];
		var path = img[1];
		var version = img[2];
		var descParts;

		path = path.replace(/\$([0-9]+)/g, function(m) {
			if (m[1] == '0') return descriptor;

			if (!descParts) descParts = descriptor.split(imageMap.descriptorDelimiter);

			return descParts[m[1]-1];
		});

		return imageMap.domains[domain] + path + ((version && version != 1) ? ('?v' + version) : '');
	};


	this.loadNextPage();
};

</script>

</body>
</html>
